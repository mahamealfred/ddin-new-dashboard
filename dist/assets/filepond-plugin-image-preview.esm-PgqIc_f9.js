/*!
 * FilePondPluginImageExifOrientation 1.0.11
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://pqina.nl/filepond/ for details.
 */const ge=e=>/^image\/jpeg/.test(e.type),S={JPEG:65496,APP1:65505,EXIF:1165519206,TIFF:18761,Orientation:274,Unknown:65280},k=(e,t,i=!1)=>e.getUint16(t,i),Q=(e,t,i=!1)=>e.getUint32(t,i),fe=e=>new Promise((t,i)=>{const n=new FileReader;n.onload=function(a){const c=new DataView(a.target.result);if(k(c,0)!==S.JPEG){t(-1);return}const l=c.byteLength;let o=2;for(;o<l;){const d=k(c,o);if(o+=2,d===S.APP1){if(Q(c,o+=2)!==S.EXIF)break;const u=k(c,o+=6)===S.TIFF;o+=Q(c,o+4,u);const m=k(c,o,u);o+=2;for(let g=0;g<m;g++)if(k(c,o+g*12,u)===S.Orientation){t(k(c,o+g*12+8,u));return}}else{if((d&S.Unknown)!==S.Unknown)break;o+=k(c,o)}}t(-1)},n.readAsArrayBuffer(e.slice(0,64*1024))}),ue=typeof window<"u"&&typeof window.document<"u",pe=()=>ue,me="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4QA6RXhpZgAATU0AKgAAAAgAAwESAAMAAAABAAYAAAEoAAMAAAABAAIAAAITAAMAAAABAAEAAAAAAAD/2wBDAP//////////////////////////////////////////////////////////////////////////////////////wAALCAABAAIBASIA/8QAJgABAAAAAAAAAAAAAAAAAAAAAxABAAAAAAAAAAAAAAAAAAAAAP/aAAgBAQAAPwBH/9k=";let re;const X=pe()?new Image:{};X.onload=()=>re=X.naturalWidth>X.naturalHeight;X.src=me;const we=()=>re,Ae=({addFilter:e,utils:t})=>{const{Type:i,isFile:n}=t;return e("DID_LOAD_ITEM",(a,{query:c})=>new Promise((l,o)=>{const d=a.file;if(!n(d)||!ge(d)||!c("GET_ALLOW_IMAGE_EXIF_ORIENTATION")||!we())return l(a);fe(d).then(u=>{a.setMetadata("exif",{orientation:u}),l(a)})})),{options:{allowImageExifOrientation:[!0,i.BOOLEAN]}}},Ee=typeof window<"u"&&typeof window.document<"u";Ee&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:Ae}));/*!
 * FilePondPluginImagePreview 4.6.12
 * Licensed under MIT, https://opensource.org/licenses/MIT/
 * Please visit https://pqina.nl/filepond/ for details.
 */const Ie=e=>/^image/.test(e.type),ee=(e,t)=>N(e.x*t,e.y*t),te=(e,t)=>N(e.x+t.x,e.y+t.y),ye=e=>{const t=Math.sqrt(e.x*e.x+e.y*e.y);return t===0?{x:0,y:0}:N(e.x/t,e.y/t)},q=(e,t,i)=>{const n=Math.cos(t),a=Math.sin(t),c=N(e.x-i.x,e.y-i.y);return N(i.x+n*c.x-a*c.y,i.y+a*c.x+n*c.y)},N=(e=0,t=0)=>({x:e,y:t}),C=(e,t,i=1,n)=>{if(typeof e=="string")return parseFloat(e)*i;if(typeof e=="number")return e*(n?t[n]:Math.min(t.width,t.height))},_e=(e,t,i)=>{const n=e.borderStyle||e.lineStyle||"solid",a=e.backgroundColor||e.fontColor||"transparent",c=e.borderColor||e.lineColor||"transparent",l=C(e.borderWidth||e.lineWidth,t,i),o=e.lineCap||"round",d=e.lineJoin||"round",u=typeof n=="string"?"":n.map(g=>C(g,t,i)).join(","),m=e.opacity||1;return{"stroke-linecap":o,"stroke-linejoin":d,"stroke-width":l||0,"stroke-dasharray":u,stroke:c,fill:a,opacity:m}},G=e=>e!=null,Me=(e,t,i=1)=>{let n=C(e.x,t,i,"width")||C(e.left,t,i,"width"),a=C(e.y,t,i,"height")||C(e.top,t,i,"height"),c=C(e.width,t,i,"width"),l=C(e.height,t,i,"height"),o=C(e.right,t,i,"width"),d=C(e.bottom,t,i,"height");return G(a)||(G(l)&&G(d)?a=t.height-l-d:a=d),G(n)||(G(c)&&G(o)?n=t.width-c-o:n=o),G(c)||(G(n)&&G(o)?c=t.width-n-o:c=0),G(l)||(G(a)&&G(d)?l=t.height-a-d:l=0),{x:n||0,y:a||0,width:c||0,height:l||0}},xe=e=>e.map((t,i)=>`${i===0?"M":"L"} ${t.x} ${t.y}`).join(" "),O=(e,t)=>Object.keys(t).forEach(i=>e.setAttribute(i,t[i])),Te="http://www.w3.org/2000/svg",L=(e,t)=>{const i=document.createElementNS(Te,e);return t&&O(i,t),i},Re=e=>O(e,{...e.rect,...e.styles}),Pe=e=>{const t=e.rect.x+e.rect.width*.5,i=e.rect.y+e.rect.height*.5,n=e.rect.width*.5,a=e.rect.height*.5;return O(e,{cx:t,cy:i,rx:n,ry:a,...e.styles})},Ce={contain:"xMidYMid meet",cover:"xMidYMid slice"},ve=(e,t)=>{O(e,{...e.rect,...e.styles,preserveAspectRatio:Ce[t.fit]||"none"})},De={left:"start",center:"middle",right:"end"},Ge=(e,t,i,n)=>{const a=C(t.fontSize,i,n),c=t.fontFamily||"sans-serif",l=t.fontWeight||"normal",o=De[t.textAlign]||"start";O(e,{...e.rect,...e.styles,"stroke-width":0,"font-weight":l,"font-size":a,"font-family":c,"text-anchor":o}),e.text!==t.text&&(e.text=t.text,e.textContent=t.text.length?t.text:" ")},Ve=(e,t,i,n)=>{O(e,{...e.rect,...e.styles,fill:"none"});const a=e.childNodes[0],c=e.childNodes[1],l=e.childNodes[2],o=e.rect,d={x:e.rect.x+e.rect.width,y:e.rect.y+e.rect.height};if(O(a,{x1:o.x,y1:o.y,x2:d.x,y2:d.y}),!t.lineDecoration)return;c.style.display="none",l.style.display="none";const u=ye({x:d.x-o.x,y:d.y-o.y}),m=C(.05,i,n);if(t.lineDecoration.indexOf("arrow-begin")!==-1){const g=ee(u,m),y=te(o,g),A=q(o,2,y),w=q(o,-2,y);O(c,{style:"display:block;",d:`M${A.x},${A.y} L${o.x},${o.y} L${w.x},${w.y}`})}if(t.lineDecoration.indexOf("arrow-end")!==-1){const g=ee(u,-m),y=te(d,g),A=q(d,2,y),w=q(d,-2,y);O(l,{style:"display:block;",d:`M${A.x},${A.y} L${d.x},${d.y} L${w.x},${w.y}`})}},Oe=(e,t,i,n)=>{O(e,{...e.styles,fill:"none",d:xe(t.points.map(a=>({x:C(a.x,i,n,"width"),y:C(a.y,i,n,"height")})))})},Y=e=>t=>L(e,{id:t.id}),Se=e=>{const t=L("image",{id:e.id,"stroke-linecap":"round","stroke-linejoin":"round",opacity:"0"});return t.onload=()=>{t.setAttribute("opacity",e.opacity||1)},t.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",e.src),t},ke=e=>{const t=L("g",{id:e.id,"stroke-linecap":"round","stroke-linejoin":"round"}),i=L("line");t.appendChild(i);const n=L("path");t.appendChild(n);const a=L("path");return t.appendChild(a),t},We={image:Se,rect:Y("rect"),ellipse:Y("ellipse"),text:Y("text"),path:Y("path"),line:ke},Le={rect:Re,ellipse:Pe,image:ve,text:Ge,path:Oe,line:Ve},He=(e,t)=>We[e](t),Fe=(e,t,i,n,a)=>{t!=="path"&&(e.rect=Me(i,n,a)),e.styles=_e(i,n,a),Le[t](e,i,n,a)},be=["x","y","left","top","right","bottom","width","height"],Ne=e=>typeof e=="string"&&/%/.test(e)?parseFloat(e)/100:e,Ue=e=>{const[t,i]=e,n=i.points?{}:be.reduce((a,c)=>(a[c]=Ne(i[c]),a),{});return[t,{zIndex:0,...i,...n}]},Be=(e,t)=>e[1].zIndex>t[1].zIndex?1:e[1].zIndex<t[1].zIndex?-1:0,qe=e=>e.utils.createView({name:"image-preview-markup",tag:"svg",ignoreRect:!0,mixins:{apis:["width","height","crop","markup","resize","dirty"]},write:({root:t,props:i})=>{if(!i.dirty)return;const{crop:n,resize:a,markup:c}=i,l=i.width,o=i.height;let d=n.width,u=n.height;if(a){const{size:A}=a;let w=A&&A.width,x=A&&A.height;const h=a.mode,_=a.upscale;w&&!x&&(x=w),x&&!w&&(w=x);const s=d<w&&u<x;if(!s||s&&_){let r=w/d,f=x/u;if(h==="force")d=w,u=x;else{let p;h==="cover"?p=Math.max(r,f):h==="contain"&&(p=Math.min(r,f)),d=d*p,u=u*p}}}const m={width:l,height:o};t.element.setAttribute("width",m.width),t.element.setAttribute("height",m.height);const g=Math.min(l/d,o/u);t.element.innerHTML="";const y=t.query("GET_IMAGE_PREVIEW_MARKUP_FILTER");c.filter(y).map(Ue).sort(Be).forEach(A=>{const[w,x]=A,h=He(w,x);Fe(h,w,x,m,g),t.element.appendChild(h)})}}),b=(e,t)=>({x:e,y:t}),Ye=(e,t)=>e.x*t.x+e.y*t.y,ie=(e,t)=>b(e.x-t.x,e.y-t.y),Xe=(e,t)=>Ye(ie(e,t),ie(e,t)),ne=(e,t)=>Math.sqrt(Xe(e,t)),ae=(e,t)=>{const i=e,n=1.5707963267948966,a=t,c=1.5707963267948966-t,l=Math.sin(n),o=Math.sin(a),d=Math.sin(c),u=Math.cos(c),m=i/l,g=m*o,y=m*d;return b(u*g,u*y)},ze=(e,t)=>{const i=e.width,n=e.height,a=ae(i,t),c=ae(n,t),l=b(e.x+Math.abs(a.x),e.y-Math.abs(a.y)),o=b(e.x+e.width+Math.abs(c.y),e.y+Math.abs(c.x)),d=b(e.x-Math.abs(c.y),e.y+e.height-Math.abs(c.x));return{width:ne(l,o),height:ne(l,d)}},$e=(e,t,i=1)=>{const n=e.height/e.width;let a=1,c=t,l=1,o=n;o>c&&(o=c,l=o/n);const d=Math.max(a/l,c/o),u=e.width/(i*d*l),m=u*t;return{width:u,height:m}},ce=(e,t,i,n)=>{const a=n.x>.5?1-n.x:n.x,c=n.y>.5?1-n.y:n.y,l=a*2*e.width,o=c*2*e.height,d=ze(t,i);return Math.max(d.width/l,d.height/o)},oe=(e,t)=>{let i=e.width,n=i*t;n>e.height&&(n=e.height,i=n/t);const a=(e.width-i)*.5,c=(e.height-n)*.5;return{x:a,y:c,width:i,height:n}},Ze=(e,t={})=>{let{zoom:i,rotation:n,center:a,aspectRatio:c}=t;c||(c=e.height/e.width);const l=$e(e,c,i),o={x:l.width*.5,y:l.height*.5},d={x:0,y:0,width:l.width,height:l.height,center:o},u=typeof t.scaleToFit>"u"||t.scaleToFit,m=ce(e,oe(d,c),n,u?a:{x:.5,y:.5}),g=i*m;return{widthFloat:l.width/g,heightFloat:l.height/g,width:Math.round(l.width/g),height:Math.round(l.height/g)}},V={type:"spring",stiffness:.5,damping:.45,mass:10},je=e=>e.utils.createView({name:"image-bitmap",ignoreRect:!0,mixins:{styles:["scaleX","scaleY"]},create:({root:t,props:i})=>{t.appendChild(i.image)}}),Ke=e=>e.utils.createView({name:"image-canvas-wrapper",tag:"div",ignoreRect:!0,mixins:{apis:["crop","width","height"],styles:["originX","originY","translateX","translateY","scaleX","scaleY","rotateZ"],animations:{originX:V,originY:V,scaleX:V,scaleY:V,translateX:V,translateY:V,rotateZ:V}},create:({root:t,props:i})=>{i.width=i.image.width,i.height=i.image.height,t.ref.bitmap=t.appendChildView(t.createChildView(je(e),{image:i.image}))},write:({root:t,props:i})=>{const{flip:n}=i.crop,{bitmap:a}=t.ref;a.scaleX=n.horizontal?-1:1,a.scaleY=n.vertical?-1:1}}),Je=e=>e.utils.createView({name:"image-clip",tag:"div",ignoreRect:!0,mixins:{apis:["crop","markup","resize","width","height","dirty","background"],styles:["width","height","opacity"],animations:{opacity:{type:"tween",duration:250}}},didWriteView:function({root:t,props:i}){i.background&&(t.element.style.backgroundColor=i.background)},create:({root:t,props:i})=>{t.ref.image=t.appendChildView(t.createChildView(Ke(e),Object.assign({},i))),t.ref.createMarkup=()=>{t.ref.markup||(t.ref.markup=t.appendChildView(t.createChildView(qe(e),Object.assign({},i))))},t.ref.destroyMarkup=()=>{t.ref.markup&&(t.removeChildView(t.ref.markup),t.ref.markup=null)};const n=t.query("GET_IMAGE_PREVIEW_TRANSPARENCY_INDICATOR");n!==null&&(n==="grid"?t.element.dataset.transparencyIndicator=n:t.element.dataset.transparencyIndicator="color")},write:({root:t,props:i,shouldOptimize:n})=>{const{crop:a,markup:c,resize:l,dirty:o,width:d,height:u}=i;t.ref.image.crop=a;const m={x:0,y:0,width:d,height:u,center:{x:d*.5,y:u*.5}},g={width:t.ref.image.width,height:t.ref.image.height},y={x:a.center.x*g.width,y:a.center.y*g.height},A={x:m.center.x-g.width*a.center.x,y:m.center.y-g.height*a.center.y},w=Math.PI*2+a.rotation%(Math.PI*2),x=a.aspectRatio||g.height/g.width,h=typeof a.scaleToFit>"u"||a.scaleToFit,_=ce(g,oe(m,x),w,h?a.center:{x:.5,y:.5}),s=a.zoom*_;c&&c.length?(t.ref.createMarkup(),t.ref.markup.width=d,t.ref.markup.height=u,t.ref.markup.resize=l,t.ref.markup.dirty=o,t.ref.markup.markup=c,t.ref.markup.crop=Ze(g,a)):t.ref.markup&&t.ref.destroyMarkup();const r=t.ref.image;if(n){r.originX=null,r.originY=null,r.translateX=null,r.translateY=null,r.rotateZ=null,r.scaleX=null,r.scaleY=null;return}r.originX=y.x,r.originY=y.y,r.translateX=A.x,r.translateY=A.y,r.rotateZ=w,r.scaleX=s,r.scaleY=s}}),Qe=e=>e.utils.createView({name:"image-preview",tag:"div",ignoreRect:!0,mixins:{apis:["image","crop","markup","resize","dirty","background"],styles:["translateY","scaleX","scaleY","opacity"],animations:{scaleX:V,scaleY:V,translateY:V,opacity:{type:"tween",duration:400}}},create:({root:t,props:i})=>{t.ref.clip=t.appendChildView(t.createChildView(Je(e),{id:i.id,image:i.image,crop:i.crop,markup:i.markup,resize:i.resize,dirty:i.dirty,background:i.background}))},write:({root:t,props:i,shouldOptimize:n})=>{const{clip:a}=t.ref,{image:c,crop:l,markup:o,resize:d,dirty:u}=i;if(a.crop=l,a.markup=o,a.resize=d,a.dirty=u,a.opacity=n?0:1,n||t.rect.element.hidden)return;const m=c.height/c.width;let g=l.aspectRatio||m;const y=t.rect.inner.width,A=t.rect.inner.height;let w=t.query("GET_IMAGE_PREVIEW_HEIGHT");const x=t.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),h=t.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),_=t.query("GET_PANEL_ASPECT_RATIO"),s=t.query("GET_ALLOW_MULTIPLE");_&&!s&&(w=y*_,g=_);let r=w!==null?w:Math.max(x,Math.min(y*g,h)),f=r/g;f>y&&(f=y,r=f*g),r>A&&(r=A,f=A/g),a.width=f,a.height=r}});let et=`<svg width="500" height="200" viewBox="0 0 500 200" preserveAspectRatio="none">
    <defs>
        <radialGradient id="gradient-__UID__" cx=".5" cy="1.25" r="1.15">
            <stop offset='50%' stop-color='#000000'/>
            <stop offset='56%' stop-color='#0a0a0a'/>
            <stop offset='63%' stop-color='#262626'/>
            <stop offset='69%' stop-color='#4f4f4f'/>
            <stop offset='75%' stop-color='#808080'/>
            <stop offset='81%' stop-color='#b1b1b1'/>
            <stop offset='88%' stop-color='#dadada'/>
            <stop offset='94%' stop-color='#f6f6f6'/>
            <stop offset='100%' stop-color='#ffffff'/>
        </radialGradient>
        <mask id="mask-__UID__">
            <rect x="0" y="0" width="500" height="200" fill="url(#gradient-__UID__)"></rect>
        </mask>
    </defs>
    <rect x="0" width="500" height="200" fill="currentColor" mask="url(#mask-__UID__)"></rect>
</svg>`,se=0;const tt=e=>e.utils.createView({name:"image-preview-overlay",tag:"div",ignoreRect:!0,create:({root:t,props:i})=>{let n=et;if(document.querySelector("base")){const a=new URL(window.location.href.replace(window.location.hash,"")).href;n=n.replace(/url\(\#/g,"url("+a+"#")}se++,t.element.classList.add(`filepond--image-preview-overlay-${i.status}`),t.element.innerHTML=n.replace(/__UID__/g,se)},mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:25}}}}),it=function(){self.onmessage=e=>{createImageBitmap(e.data.message.file).then(t=>{self.postMessage({id:e.data.id,message:t},[t])})}},nt=function(){self.onmessage=e=>{const t=e.data.message.imageData,i=e.data.message.colorMatrix,n=t.data,a=n.length,c=i[0],l=i[1],o=i[2],d=i[3],u=i[4],m=i[5],g=i[6],y=i[7],A=i[8],w=i[9],x=i[10],h=i[11],_=i[12],s=i[13],r=i[14],f=i[15],p=i[16],E=i[17],I=i[18],T=i[19];let M=0,P=0,v=0,R=0,D=0;for(;M<a;M+=4)P=n[M]/255,v=n[M+1]/255,R=n[M+2]/255,D=n[M+3]/255,n[M]=Math.max(0,Math.min((P*c+v*l+R*o+D*d+u)*255,255)),n[M+1]=Math.max(0,Math.min((P*m+v*g+R*y+D*A+w)*255,255)),n[M+2]=Math.max(0,Math.min((P*x+v*h+R*_+D*s+r)*255,255)),n[M+3]=Math.max(0,Math.min((P*f+v*p+R*E+D*I+T)*255,255));self.postMessage({id:e.data.id,message:t},[t.data.buffer])}},at=(e,t)=>{let i=new Image;i.onload=()=>{const n=i.naturalWidth,a=i.naturalHeight;i=null,t(n,a)},i.src=e},st={1:()=>[1,0,0,1,0,0],2:e=>[-1,0,0,1,e,0],3:(e,t)=>[-1,0,0,-1,e,t],4:(e,t)=>[1,0,0,-1,0,t],5:()=>[0,1,1,0,0,0],6:(e,t)=>[0,1,-1,0,t,0],7:(e,t)=>[0,-1,-1,0,t,e],8:e=>[0,-1,1,0,0,e]},rt=(e,t,i,n)=>{n!==-1&&e.transform.apply(e,st[n](t,i))},ct=(e,t,i,n)=>{t=Math.round(t),i=Math.round(i);const a=document.createElement("canvas");a.width=t,a.height=i;const c=a.getContext("2d");return n>=5&&n<=8&&([t,i]=[i,t]),rt(c,t,i,n),c.drawImage(e,0,0,t,i),a},le=e=>/^image/.test(e.type)&&!/svg/.test(e.type),ot=10,lt=10,dt=e=>{const t=Math.min(ot/e.width,lt/e.height),i=document.createElement("canvas"),n=i.getContext("2d"),a=i.width=Math.ceil(e.width*t),c=i.height=Math.ceil(e.height*t);n.drawImage(e,0,0,a,c);let l=null;try{l=n.getImageData(0,0,a,c).data}catch{return null}const o=l.length;let d=0,u=0,m=0,g=0;for(;g<o;g+=4)d+=l[g]*l[g],u+=l[g+1]*l[g+1],m+=l[g+2]*l[g+2];return d=$(d,o),u=$(u,o),m=$(m,o),{r:d,g:u,b:m}},$=(e,t)=>Math.floor(Math.sqrt(e/(t/4))),ht=(e,t)=>(t=t||document.createElement("canvas"),t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0),t),gt=e=>{let t;try{t=new ImageData(e.width,e.height)}catch{t=document.createElement("canvas").getContext("2d").createImageData(e.width,e.height)}return t.data.set(new Uint8ClampedArray(e.data)),t},ft=e=>new Promise((t,i)=>{const n=new Image;n.crossOrigin="Anonymous",n.onload=()=>{t(n)},n.onerror=a=>{i(a)},n.src=e}),ut=e=>{const t=tt(e),i=Qe(e),{createWorker:n}=e.utils,a=(s,r,f)=>new Promise(p=>{s.ref.imageData||(s.ref.imageData=f.getContext("2d").getImageData(0,0,f.width,f.height));const E=gt(s.ref.imageData);if(!r||r.length!==20)return f.getContext("2d").putImageData(E,0,0),p();const I=n(nt);I.post({imageData:E,colorMatrix:r},T=>{f.getContext("2d").putImageData(T,0,0),I.terminate(),p()},[E.data.buffer])}),c=(s,r)=>{s.removeChildView(r),r.image.width=1,r.image.height=1,r._destroy()},l=({root:s})=>{const r=s.ref.images.shift();return r.opacity=0,r.translateY=-15,s.ref.imageViewBin.push(r),r},o=({root:s,props:r,image:f})=>{const p=r.id,E=s.query("GET_ITEM",{id:p});if(!E)return;const I=E.getMetadata("crop")||{center:{x:.5,y:.5},flip:{horizontal:!1,vertical:!1},zoom:1,rotation:0,aspectRatio:null},T=s.query("GET_IMAGE_TRANSFORM_CANVAS_BACKGROUND_COLOR");let M,P,v=!1;s.query("GET_IMAGE_PREVIEW_MARKUP_SHOW")&&(M=E.getMetadata("markup")||[],P=E.getMetadata("resize"),v=!0);const R=s.appendChildView(s.createChildView(i,{id:p,image:f,crop:I,resize:P,markup:M,dirty:v,background:T,opacity:0,scaleX:1.15,scaleY:1.15,translateY:15}),s.childViews.length);s.ref.images.push(R),R.opacity=1,R.scaleX=1,R.scaleY=1,R.translateY=0,setTimeout(()=>{s.dispatch("DID_IMAGE_PREVIEW_SHOW",{id:p})},250)},d=({root:s,props:r})=>{const f=s.query("GET_ITEM",{id:r.id});if(!f)return;const p=s.ref.images[s.ref.images.length-1];p.crop=f.getMetadata("crop"),p.background=s.query("GET_IMAGE_TRANSFORM_CANVAS_BACKGROUND_COLOR"),s.query("GET_IMAGE_PREVIEW_MARKUP_SHOW")&&(p.dirty=!0,p.resize=f.getMetadata("resize"),p.markup=f.getMetadata("markup"))},u=({root:s,props:r,action:f})=>{if(!/crop|filter|markup|resize/.test(f.change.key)||!s.ref.images.length)return;const p=s.query("GET_ITEM",{id:r.id});if(p){if(/filter/.test(f.change.key)){const E=s.ref.images[s.ref.images.length-1];a(s,f.change.value,E.image);return}if(/crop|markup|resize/.test(f.change.key)){const E=p.getMetadata("crop"),I=s.ref.images[s.ref.images.length-1];if(E&&E.aspectRatio&&I.crop&&I.crop.aspectRatio&&Math.abs(E.aspectRatio-I.crop.aspectRatio)>1e-5){const T=l({root:s});o({root:s,props:r,image:ht(T.image)})}else d({root:s,props:r})}}},m=s=>{const f=window.navigator.userAgent.match(/Firefox\/([0-9]+)\./),p=f?parseInt(f[1]):null;return p!==null&&p<=58?!1:"createImageBitmap"in window&&le(s)},g=({root:s,props:r})=>{const{id:f}=r,p=s.query("GET_ITEM",f);if(!p)return;const E=URL.createObjectURL(p.file);at(E,(I,T)=>{s.dispatch("DID_IMAGE_PREVIEW_CALCULATE_SIZE",{id:f,width:I,height:T})})},y=({root:s,props:r})=>{const{id:f}=r,p=s.query("GET_ITEM",f);if(!p)return;const E=URL.createObjectURL(p.file),I=()=>{ft(E).then(T)},T=M=>{URL.revokeObjectURL(E);const v=(p.getMetadata("exif")||{}).orientation||-1;let{width:R,height:D}=M;if(!R||!D)return;v>=5&&v<=8&&([R,D]=[D,R]);const z=Math.max(1,window.devicePixelRatio*.75),U=s.query("GET_IMAGE_PREVIEW_ZOOM_FACTOR")*z,W=D/R,H=s.rect.element.width,de=s.rect.element.height;let F=H,B=F*W;W>1?(F=Math.min(R,H*U),B=F*W):(B=Math.min(D,de*U),F=B/W);const j=ct(M,F,B,v),K=()=>{const he=s.query("GET_IMAGE_PREVIEW_CALCULATE_AVERAGE_IMAGE_COLOR")?dt(data):null;p.setMetadata("color",he,!0),"close"in M&&M.close(),s.ref.overlayShadow.opacity=1,o({root:s,props:r,image:j})},J=p.getMetadata("filter");J?a(s,J,j).then(K):K()};if(m(p.file)){const M=n(it);M.post({file:p.file},P=>{if(M.terminate(),!P){I();return}T(P)})}else I()},A=({root:s})=>{const r=s.ref.images[s.ref.images.length-1];r.translateY=0,r.scaleX=1,r.scaleY=1,r.opacity=1},w=({root:s})=>{s.ref.overlayShadow.opacity=1,s.ref.overlayError.opacity=0,s.ref.overlaySuccess.opacity=0},x=({root:s})=>{s.ref.overlayShadow.opacity=.25,s.ref.overlayError.opacity=1},h=({root:s})=>{s.ref.overlayShadow.opacity=.25,s.ref.overlaySuccess.opacity=1},_=({root:s})=>{s.ref.images=[],s.ref.imageData=null,s.ref.imageViewBin=[],s.ref.overlayShadow=s.appendChildView(s.createChildView(t,{opacity:0,status:"idle"})),s.ref.overlaySuccess=s.appendChildView(s.createChildView(t,{opacity:0,status:"success"})),s.ref.overlayError=s.appendChildView(s.createChildView(t,{opacity:0,status:"failure"}))};return e.utils.createView({name:"image-preview-wrapper",create:_,styles:["height"],apis:["height"],destroy:({root:s})=>{s.ref.images.forEach(r=>{r.image.width=1,r.image.height=1})},didWriteView:({root:s})=>{s.ref.images.forEach(r=>{r.dirty=!1})},write:e.utils.createRoute({DID_IMAGE_PREVIEW_DRAW:A,DID_IMAGE_PREVIEW_CONTAINER_CREATE:g,DID_FINISH_CALCULATE_PREVIEWSIZE:y,DID_UPDATE_ITEM_METADATA:u,DID_THROW_ITEM_LOAD_ERROR:x,DID_THROW_ITEM_PROCESSING_ERROR:x,DID_THROW_ITEM_INVALID:x,DID_COMPLETE_ITEM_PROCESSING:h,DID_START_ITEM_PROCESSING:w,DID_REVERT_ITEM_PROCESSING:w},({root:s})=>{const r=s.ref.imageViewBin.filter(f=>f.opacity===0);s.ref.imageViewBin=s.ref.imageViewBin.filter(f=>f.opacity>0),r.forEach(f=>c(s,f)),r.length=0})})},pt=e=>{const{addFilter:t,utils:i}=e,{Type:n,createRoute:a,isFile:c}=i,l=ut(e);return t("CREATE_VIEW",o=>{const{is:d,view:u,query:m}=o;if(!d("file")||!m("GET_ALLOW_IMAGE_PREVIEW"))return;const g=({root:h,props:_})=>{const{id:s}=_,r=m("GET_ITEM",s);if(!r||!c(r.file)||r.archived)return;const f=r.file;if(!Ie(f)||!m("GET_IMAGE_PREVIEW_FILTER_ITEM")(r))return;const p="createImageBitmap"in(window||{}),E=m("GET_IMAGE_PREVIEW_MAX_FILE_SIZE");if(!p&&E&&f.size>E)return;h.ref.imagePreview=u.appendChildView(u.createChildView(l,{id:s}));const I=h.query("GET_IMAGE_PREVIEW_HEIGHT");I&&h.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:r.id,height:I});const T=!p&&f.size>m("GET_IMAGE_PREVIEW_MAX_INSTANT_PREVIEW_FILE_SIZE");h.dispatch("DID_IMAGE_PREVIEW_CONTAINER_CREATE",{id:s},T)},y=(h,_)=>{if(!h.ref.imagePreview)return;let{id:s}=_;const r=h.query("GET_ITEM",{id:s});if(!r)return;const f=h.query("GET_PANEL_ASPECT_RATIO"),p=h.query("GET_ITEM_PANEL_ASPECT_RATIO"),E=h.query("GET_IMAGE_PREVIEW_HEIGHT");if(f||p||E)return;let{imageWidth:I,imageHeight:T}=h.ref;if(!I||!T)return;const M=h.query("GET_IMAGE_PREVIEW_MIN_HEIGHT"),P=h.query("GET_IMAGE_PREVIEW_MAX_HEIGHT"),R=(r.getMetadata("exif")||{}).orientation||-1;if(R>=5&&R<=8&&([I,T]=[T,I]),!le(r.file)||h.query("GET_IMAGE_PREVIEW_UPSCALE")){const H=2048/I;I*=H,T*=H}const D=T/I,z=(r.getMetadata("crop")||{}).aspectRatio||D;let Z=Math.max(M,Math.min(T,P));const U=h.rect.element.width,W=Math.min(U*z,Z);h.dispatch("DID_UPDATE_PANEL_HEIGHT",{id:r.id,height:W})},A=({root:h})=>{h.ref.shouldRescale=!0},w=({root:h,action:_})=>{_.change.key==="crop"&&(h.ref.shouldRescale=!0)},x=({root:h,action:_})=>{h.ref.imageWidth=_.width,h.ref.imageHeight=_.height,h.ref.shouldRescale=!0,h.ref.shouldDrawPreview=!0,h.dispatch("KICK")};u.registerWriter(a({DID_RESIZE_ROOT:A,DID_STOP_RESIZE:A,DID_LOAD_ITEM:g,DID_IMAGE_PREVIEW_CALCULATE_SIZE:x,DID_UPDATE_ITEM_METADATA:w},({root:h,props:_})=>{h.ref.imagePreview&&(h.rect.element.hidden||(h.ref.shouldRescale&&(y(h,_),h.ref.shouldRescale=!1),h.ref.shouldDrawPreview&&(requestAnimationFrame(()=>{requestAnimationFrame(()=>{h.dispatch("DID_FINISH_CALCULATE_PREVIEWSIZE",{id:_.id})})}),h.ref.shouldDrawPreview=!1)))}))}),{options:{allowImagePreview:[!0,n.BOOLEAN],imagePreviewFilterItem:[()=>!0,n.FUNCTION],imagePreviewHeight:[null,n.INT],imagePreviewMinHeight:[44,n.INT],imagePreviewMaxHeight:[256,n.INT],imagePreviewMaxFileSize:[null,n.INT],imagePreviewZoomFactor:[2,n.INT],imagePreviewUpscale:[!1,n.BOOLEAN],imagePreviewMaxInstantPreviewFileSize:[1e6,n.INT],imagePreviewTransparencyIndicator:[null,n.STRING],imagePreviewCalculateAverageImageColor:[!1,n.BOOLEAN],imagePreviewMarkupShow:[!0,n.BOOLEAN],imagePreviewMarkupFilter:[()=>!0,n.FUNCTION]}}},mt=typeof window<"u"&&typeof window.document<"u";mt&&document.dispatchEvent(new CustomEvent("FilePond:pluginloaded",{detail:pt}));export{Ae as a,pt as p};
